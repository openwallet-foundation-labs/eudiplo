apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

# MinIO Component
# Adds MinIO S3-compatible object storage to the deployment

resources:
  - minio-statefulset.yaml
  - minio-service.yaml
  - minio-bucket-job.yaml

# Patch ingress to add MinIO console
patches:
  - target:
      kind: Ingress
      name: eudiplo-ingress
    patch: |-
      - op: add
        path: /spec/rules/-
        value:
          host: minio-console.localtest.me
          http:
            paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: minio
                    port:
                      number: 9001
  # Patch EUDIPLO deployment to wait for MinIO and add S3 env vars
  - target:
      kind: Deployment
      name: eudiplo
    patch: |-
      - op: add
        path: /spec/template/spec/initContainers/-
        value:
          name: wait-for-minio
          image: busybox:1.36
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
          command:
            - sh
            - -c
            - |
              until wget -qO- http://minio:9000/minio/health/ready >/dev/null 2>&1; do
                echo "waiting for minio..."; sleep 3;
              done
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: STORAGE_DRIVER
          value: "s3"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: S3_ENDPOINT
          value: "http://minio:9000"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: S3_FORCE_PATH_STYLE
          value: "true"
