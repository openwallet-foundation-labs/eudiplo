<div fxLayout="column" fxLayoutGap="24px">
  <div fxLayout="row" fxLayoutAlign="space-between center">
    <h2>{{ create ? 'Create Presentation' : 'Update Presentation' }}</h2>

    <div fxLayout="row" fxLayoutGap="8px">
      <!-- JSON View Button -->
      <button mat-stroked-button (click)="viewAsJson()" matTooltip="View/Edit as JSON">
        <mat-icon>code</mat-icon>
        JSON View
      </button>

      <!-- Predefined Configs Menu -->
      @if (create) {
        <button
          mat-stroked-button
          [matMenuTriggerFor]="templatesMenu"
          matTooltip="Load predefined configuration"
        >
          <mat-icon>template_add</mat-icon>
          Templates
        </button>
        <mat-menu #templatesMenu="matMenu">
          @for (template of predefinedConfigs; track template.name) {
            <div>
              <button mat-menu-item (click)="loadPredefinedConfig(template)">
                <mat-icon>{{ template.icon }}</mat-icon>
                <div fxLayout="column" fxLayoutAlign="start start">
                  <span>{{ template.name }}</span>
                  <small class="menu-description">{{ template.description }}</small>
                </div>
              </button>
              <button mat-menu-item (click)="previewPredefinedConfig(template)">
                <mat-icon>visibility</mat-icon>
                <span>Preview {{ template.name }}</span>
              </button>
              @if (!$last) {
                <mat-divider></mat-divider>
              }
            </div>
          }
        </mat-menu>
      }

      <!-- Back Button -->
      <button mat-icon-button [routerLink]="['../']" matTooltip="Back to list">
        <mat-icon>arrow_back</mat-icon>
      </button>
    </div>
  </div>
  <form
    [formGroup]="form"
    (ngSubmit)="createOrUpdatePresentation()"
    fxLayout="column"
    fxLayoutGap="24px"
  >
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>settings</mat-icon>
          Basic Information
        </mat-card-title>
      </mat-card-header>

      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- ID Field -->
        <mat-form-field>
          <mat-label>ID</mat-label>
          <input matInput formControlName="id" placeholder="Enter unique identifier" />
          @if (form.controls['id'].hasError('required')) {
            <mat-error> ID is required </mat-error>
          }
        </mat-form-field>

        <!-- DCQL Query Field -->
        <mat-form-field>
          <mat-label>DCQL Query</mat-label>
          <textarea
            matInput
            formControlName="dcql_query"
            placeholder='{"query": "example"}'
            rows="6"
            class="json-textarea"
            (blur)="formatJson()"
          ></textarea>
          <mat-hint
            >Enter the DCQL query in valid JSON format. Click outside to auto-format.</mat-hint
          >
          @if (form.controls['dcql_query'].hasError('required')) {
            <mat-error> DCQL Query is required </mat-error>
          }
          @if (form.controls['dcql_query'].hasError('invalidJson')) {
            <mat-error> Invalid JSON format. Please check your syntax. </mat-error>
          }
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>security</mat-icon>
          Registrar
        </mat-card-title>
      </mat-card-header>
      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- Registration Certificate Field -->
        <mat-form-field>
          <mat-label>Registration Certificate</mat-label>
          <textarea
            matInput
            formControlName="registrationCert"
            placeholder="Enter Registration Certificate"
            rows="3"
          ></textarea>
          @if (form.controls['registrationCert'].hasError('required')) {
            <mat-error> Registration Certificate is required </mat-error>
          }
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>webhook</mat-icon>
          Webhook Configuration
        </mat-card-title>
      </mat-card-header>

      <mat-card-content fxLayout="column" fxLayoutGap="16px" formGroupName="webhook">
        <!-- Webhook Configuration Section -->
        <!-- Webhook URL -->
        <mat-form-field>
          <mat-label>Webhook URL</mat-label>
          <input matInput formControlName="url" placeholder="https://your-webhook-url.com" />
          @if (form.get('webhook.url')?.hasError('required')) {
            <mat-error> Webhook URL is required </mat-error>
          }
        </mat-form-field>

        <!-- Webhook Authentication Section -->
        <div formGroupName="auth" fxLayout="column" fxLayoutGap="16px">
          <h4>Authentication</h4>

          <!-- Auth Type -->
          <mat-form-field>
            <mat-label>Authentication Type</mat-label>
            <mat-select formControlName="type">
              <mat-option value="none">None</mat-option>
              <mat-option value="apiKey">API Key</mat-option>
            </mat-select>
            @if (form.get('webhook.auth.type')?.hasError('required')) {
              <mat-error> Authentication type is required </mat-error>
            }
          </mat-form-field>

          <!-- API Key Configuration -->
          <div formGroupName="config" fxLayout="column" fxLayoutGap="16px">
            <mat-form-field>
              <mat-label>Header Name</mat-label>
              <input matInput formControlName="headerName" placeholder="X-API-Key" />
              @if (form.get('webhook.auth.config.headerName')?.hasError('required')) {
                <mat-error> Header name is required </mat-error>
              }
            </mat-form-field>

            <mat-form-field>
              <mat-label>API Key Value</mat-label>
              <input matInput formControlName="value" placeholder="Your API key" type="password" />
              @if (form.get('webhook.auth.config.value')?.hasError('required')) {
                <mat-error> API key value is required </mat-error>
              }
            </mat-form-field>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Action Buttons -->
    <div fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="end center">
      <button mat-button type="button" [routerLink]="['../']">Cancel</button>
      <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid">
        <mat-icon>{{ create ? 'add' : 'save' }}</mat-icon>

        {{ create ? 'Create' : 'Save' }} Configuration
      </button>
    </div>
  </form>
</div>
