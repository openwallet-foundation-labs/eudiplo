<div fxLayout="column" fxLayoutGap="24px">
  <div fxLayout="row" fxLayoutAlign="space-between center">
    <h2>{{ create ? 'Create Presentation' : 'Update Presentation' }}</h2>

    <div fxLayout="row" fxLayoutGap="8px">
      <!-- JSON View Button -->
      <button mat-stroked-button (click)="viewAsJson()" matTooltip="View/Edit as JSON">
        <mat-icon>code</mat-icon>
        JSON View
      </button>

      <!-- Predefined Configs Menu -->
      @if (create) {
        <button
          mat-stroked-button
          [matMenuTriggerFor]="templatesMenu"
          matTooltip="Load predefined configuration"
        >
          <mat-icon>template_add</mat-icon>
          Templates
        </button>
        <mat-menu #templatesMenu="matMenu">
          @for (template of predefinedConfigs; track template.name) {
            <div>
              <button mat-menu-item (click)="loadPredefinedConfig(template)">
                <mat-icon>{{ template.icon }}</mat-icon>
                <div fxLayout="column" fxLayoutAlign="start start">
                  <span>{{ template.name }}</span>
                  <small class="menu-description">{{ template.description }}</small>
                </div>
              </button>
              <button mat-menu-item (click)="previewPredefinedConfig(template)">
                <mat-icon>visibility</mat-icon>
                <span>Preview {{ template.name }}</span>
              </button>
              @if (!$last) {
                <mat-divider></mat-divider>
              }
            </div>
          }
        </mat-menu>
      }

      <!-- Back Button -->
      <button mat-icon-button [routerLink]="['../']" matTooltip="Back to list">
        <mat-icon>arrow_back</mat-icon>
      </button>
    </div>
  </div>
  <form
    [formGroup]="form"
    (ngSubmit)="createOrUpdatePresentation()"
    fxLayout="column"
    fxLayoutGap="24px"
  >
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>settings</mat-icon>
          Basic Information
        </mat-card-title>
      </mat-card-header>

      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- ID Field -->
        <mat-form-field>
          <mat-label>ID</mat-label>
          <input matInput formControlName="id" placeholder="Enter unique identifier" />
          @if (form.controls['id'].hasError('required')) {
            <mat-error> ID is required </mat-error>
          }
        </mat-form-field>

        <!-- Description Field -->
        <mat-form-field>
          <mat-label>Description</mat-label>
          <input matInput formControlName="description" placeholder="Enter description" />
          @if (form.controls['description'].hasError('required')) {
            <mat-error> Description is required </mat-error>
          }
        </mat-form-field>

        <!-- DCQL Query Field -->
        <h4>DCQL Query</h4>
        <ngx-monaco-editor
          formControlName="dcql_query"
          [options]="editorOptions"
        ></ngx-monaco-editor>

        <mat-form-field>
          <mat-label>Lifetime of the request</mat-label>
          <input matInput formControlName="lifeTime" type="number" />
          @if (form.controls['lifeTime'].hasError('required')) {
            <mat-error> Lifetime is required </mat-error>
          }
          @if (form.controls['lifeTime'].hasError('min')) {
            <mat-error> Lifetime must be at least 1 </mat-error>
          }
          <mat-hint> Lifetime is in seconds </mat-hint>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>security</mat-icon>
          Registrar
        </mat-card-title>
      </mat-card-header>
      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- Registration Certificate Field -->
        <h4>Registrar Certificate (optional)</h4>
        <ngx-monaco-editor
          formControlName="registrarCert"
          [options]="editorOptions"
        ></ngx-monaco-editor>
      </mat-card-content>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>webhook</mat-icon>
          Webhook Configuration
        </mat-card-title>
      </mat-card-header>

      <mat-card-content fxLayout="column" fxLayoutGap="16px" formGroupName="webhook">
        <!-- Webhook Configuration Section -->
        <!-- Webhook URL -->
        <mat-form-field>
          <mat-label>Webhook URL</mat-label>
          <input matInput formControlName="url" placeholder="https://your-webhook-url.com" />
          @if (form.get('webhook.url')?.hasError('required')) {
            <mat-error> Webhook URL is required </mat-error>
          }
        </mat-form-field>

        <!-- Webhook Authentication Section -->
        <div formGroupName="auth" fxLayout="column" fxLayoutGap="16px">
          <h4>Authentication</h4>

          <!-- Auth Type -->
          <mat-form-field>
            <mat-label>Authentication Type</mat-label>
            <mat-select formControlName="type">
              <mat-option value="none">None</mat-option>
              <mat-option value="apiKey">API Key</mat-option>
            </mat-select>
            @if (form.get('webhook.auth.type')?.hasError('required')) {
              <mat-error> Authentication type is required </mat-error>
            }
          </mat-form-field>

          <!-- API Key Configuration -->
          <div formGroupName="config" fxLayout="column" fxLayoutGap="16px">
            <mat-form-field>
              <mat-label>Header Name</mat-label>
              <input matInput formControlName="headerName" placeholder="X-API-Key" />
              @if (form.get('webhook.auth.config.headerName')?.hasError('required')) {
                <mat-error> Header name is required </mat-error>
              }
            </mat-form-field>

            <mat-form-field>
              <mat-label>API Key Value</mat-label>
              <input matInput formControlName="value" placeholder="Your API key" type="password" />
              <button
                mat-icon-button
                matSuffix
                (click)="
                  copyToClipboard(form.get('webhook.auth.config.value')?.value, 'Client Secret')
                "
                matTooltip="Copy to clipboard"
              >
                <mat-icon>content_copy</mat-icon>
              </button>
              @if (form.get('webhook.auth.config.value')?.hasError('required')) {
                <mat-error> API key value is required </mat-error>
              }
            </mat-form-field>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Action Buttons -->
    <div fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="end center">
      <button mat-button type="button" [routerLink]="['../']">Cancel</button>
      <button mat-flat-button color="primary" type="submit" [disabled]="form.invalid">
        <mat-icon>{{ create ? 'add' : 'save' }}</mat-icon>

        {{ create ? 'Create' : 'Save' }} Configuration
      </button>
    </div>
  </form>
</div>
