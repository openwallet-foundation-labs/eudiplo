<div fxLayout="column" fxFlex fxLayoutGap="24px">
  <!-- Header -->
  <div fxLayout="row" fxLayoutAlign="space-between center">
    <h2>{{ create ? 'Create' : 'Edit' }} Credential Configuration</h2>
    <div fxLayout="row" fxLayoutGap="8px">
      <!-- JSON View Button -->
      <button mat-stroked-button (click)="viewAsJson()" matTooltip="View/Edit as JSON">
        <mat-icon>code</mat-icon>
        JSON View
      </button>

      <!-- Predefined Configs Menu -->
      @if (create) {
        <button
          mat-stroked-button
          [matMenuTriggerFor]="templatesMenu"
          matTooltip="Load predefined configuration"
        >
          <mat-icon>template_add</mat-icon>
          Templates
        </button>
        <mat-menu #templatesMenu="matMenu">
          @for (template of predefinedConfigs; track template.name) {
            <div>
              <button mat-menu-item (click)="loadPredefinedConfig(template)">
                <mat-icon>{{ template.icon }}</mat-icon>
                <div fxLayout="column" fxLayoutAlign="start start">
                  <span>{{ template.name }}</span>
                  <small class="menu-description">{{ template.description }}</small>
                </div>
              </button>
              <button mat-menu-item (click)="previewPredefinedConfig(template)">
                <mat-icon>visibility</mat-icon>
                <span>Preview {{ template.name }}</span>
              </button>
              @if (!$last) {
                <mat-divider></mat-divider>
              }
            </div>
          }
        </mat-menu>
      }

      <!-- Back Button -->
      <button matIconButton [routerLink]="['../']" matTooltip="Back to list">
        <mat-icon>arrow_back</mat-icon>
      </button>
    </div>
  </div>

  <!-- Main Form -->
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <!-- Basic Information Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>settings</mat-icon>
          Basic Information
        </mat-card-title>
      </mat-card-header>
      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- Configuration ID -->
        <div fxLayout="row" fxLayoutGap="8px" fxLayoutAlign="start center">
          <mat-form-field fxFlex>
            <mat-label>Configuration ID</mat-label>
            <input matInput formControlName="id" placeholder="unique-credential-config-id" />
            <mat-icon matSuffix>fingerprint</mat-icon>
            @if (form.get('id')?.invalid && form.get('id')?.touched) {
              <mat-error>Configuration ID is required</mat-error>
            }
          </mat-form-field>
        </div>

        <mat-form-field>
          <mat-label>Description</mat-label>
          <input matInput formControlName="description" placeholder="Description" />
          <mat-icon matSuffix>description</mat-icon>
          @if (form.get('description')?.invalid && form.get('description')?.touched) {
            <mat-error>Description is required</mat-error>
          }
        </mat-form-field>

        <!-- Credential Format -->
        <mat-form-field>
          <mat-label>Credential Format</mat-label>
          <mat-select formControlName="format">
            <mat-option value="dc+sd-jwt">SD-JWT VC (dc+sd-jwt)</mat-option>
            <mat-option value="mso_mdoc">mDOC (mso_mdoc)</mat-option>
          </mat-select>
          <mat-icon matSuffix>format_shapes</mat-icon>
          <mat-hint>Select the credential format to issue</mat-hint>
        </mat-form-field>

        <!-- Certificate Selection -->
        <mat-form-field>
          <mat-label>Signing Certificate</mat-label>
          <mat-select formControlName="certId">
            <mat-option value="">
              <em>No certificate selected</em>
            </mat-option>
            @for (cert of certificates; track cert.id) {
              <mat-option [value]="cert.id">
                <div fxLayout="column">
                  <span
                    ><strong>{{ cert.id }}</strong></span
                  >
                  <span class="option-description"
                    >{{ cert.description }} (Key: {{ cert.keyId }})</span
                  >
                </div>
              </mat-option>
            }
          </mat-select>
          <mat-icon matSuffix>badge</mat-icon>
          <mat-hint>Select the certificate for signing credentials</mat-hint>
        </mat-form-field>

        <!-- Lifetime -->
        <div fxLayout="row" fxLayoutGap="16px" fxLayout.lt-md="column">
          <mat-form-field fxFlex>
            <mat-label>Credential Lifetime</mat-label>
            <mat-select
              [value]="selectedLifetimePreset"
              (selectionChange)="onLifetimePresetChange($event.value)"
            >
              @for (preset of lifetimePresets; track preset.value) {
                <mat-option [value]="preset.value">{{ preset.label }}</mat-option>
              }
            </mat-select>
            <mat-icon matSuffix>schedule</mat-icon>
            <mat-hint>
              @if (!customLifetime && form.get('lifeTime')?.value) {
                {{ formatLifetime(form.get('lifeTime')?.value) }}
              } @else {
                Select a preset or enter custom value
              }
            </mat-hint>
          </mat-form-field>
          @if (customLifetime) {
            <mat-form-field fxFlex>
              <mat-label>Custom Lifetime (seconds)</mat-label>
              <input matInput type="number" formControlName="lifeTime" placeholder="3600" min="1" />
              <mat-icon matSuffix>edit</mat-icon>
              <mat-hint>= {{ formatLifetime(form.get('lifeTime')?.value || 0) }}</mat-hint>
            </mat-form-field>
          }
        </div>

        <!-- Scope -->
        <mat-form-field>
          <mat-label>Scope</mat-label>
          <input matInput formControlName="scope" placeholder="scope" />
          <mat-hint>Select the scope for the credential</mat-hint>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- Feature Configuration Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>tune</mat-icon>
          Feature Configuration
        </mat-card-title>
      </mat-card-header>
      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- Feature Toggles -->
        <div fxLayout="row" fxLayoutGap="32px" fxLayout.lt-md="column">
          <div fxFlex>
            <mat-slide-toggle formControlName="keyBinding">
              <div fxLayout="column">
                <span><strong>Key Binding</strong></span>
                <span class="toggle-description">Enable to issue key-bound credentials</span>
              </div>
            </mat-slide-toggle>
          </div>
          <div fxFlex>
            <mat-slide-toggle formControlName="statusManagement">
              <div fxLayout="column">
                <span><strong>Status Management</strong></span>
                <span class="toggle-description">Enable credential status tracking</span>
              </div>
            </mat-slide-toggle>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Display Configuration Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>palette</mat-icon>
          Display Configuration
        </mat-card-title>
        <mat-card-subtitle>
          Configure how credentials appear in wallets and viewers
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div formArrayName="displayConfigs">
          @for (displayConfig of displayConfigs.controls; track $index; let i = $index) {
            <mat-card class="display-config-card" [formGroupName]="i">
              <mat-card-header>
                <mat-card-title>
                  <span>Display Configuration {{ i + 1 }}</span>
                  @if (displayConfigs.length > 1) {
                    <button
                      matIconButton
                      type="button"
                      color="warn"
                      (click)="removeDisplayConfig(i)"
                      matTooltip="Remove this display configuration"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  }
                </mat-card-title>
              </mat-card-header>
              <mat-card-content fxLayout="column" fxLayoutGap="16px">
                <!-- Basic Display Information -->
                <div fxLayout="row" fxLayoutGap="16px" fxLayout.lt-md="column">
                  <mat-form-field fxFlex>
                    <mat-label>Display Name</mat-label>
                    <input matInput formControlName="name" placeholder="PID" required />
                    <mat-icon matSuffix>title</mat-icon>
                    <mat-hint>Short name shown in wallet</mat-hint>
                  </mat-form-field>

                  <mat-form-field fxFlex>
                    <mat-label>Locale</mat-label>
                    <mat-select formControlName="locale">
                      <mat-option value="en-US">English (US)</mat-option>
                      <mat-option value="en-GB">English (UK)</mat-option>
                      <mat-option value="de-DE">German</mat-option>
                      <mat-option value="fr-FR">French</mat-option>
                      <mat-option value="es-ES">Spanish</mat-option>
                      <mat-option value="it-IT">Italian</mat-option>
                    </mat-select>
                    <mat-icon matSuffix>language</mat-icon>
                  </mat-form-field>
                </div>

                <!-- Description -->
                <mat-form-field>
                  <mat-label>Description</mat-label>
                  <input
                    matInput
                    formControlName="description"
                    placeholder="PID Credential"
                    required
                  />
                  <mat-icon matSuffix>description</mat-icon>
                  <mat-hint>Detailed description of the credential</mat-hint>
                </mat-form-field>

                <!-- Colors -->
                <div fxLayout="row" fxLayoutGap="16px" fxLayout.lt-md="column">
                  <div fxFlex fxLayout="row" fxLayoutGap="8px" fxLayoutAlign="start center">
                    <span
                      class="color-swatch"
                      [style.background-color]="
                        displayConfig.get('background_color')?.value || '#FFFFFF'
                      "
                    ></span>
                    <mat-form-field fxFlex>
                      <mat-label>Background Color</mat-label>
                      <input
                        matInput
                        formControlName="background_color"
                        placeholder="#FFFFFF"
                        pattern="^#[0-9A-Fa-f]{6}$"
                      />
                      <mat-icon matSuffix>palette</mat-icon>
                      <mat-hint>Hex color code (e.g., #FFFFFF)</mat-hint>
                    </mat-form-field>
                  </div>

                  <div fxFlex fxLayout="row" fxLayoutGap="8px" fxLayoutAlign="start center">
                    <span
                      class="color-swatch"
                      [style.background-color]="displayConfig.get('text_color')?.value || '#000000'"
                    ></span>
                    <mat-form-field fxFlex>
                      <mat-label>Text Color</mat-label>
                      <input
                        matInput
                        formControlName="text_color"
                        placeholder="#000000"
                        pattern="^#[0-9A-Fa-f]{6}$"
                      />
                      <mat-icon matSuffix>format_color_text</mat-icon>
                      <mat-hint>Hex color code (e.g., #000000)</mat-hint>
                    </mat-form-field>
                  </div>
                </div>

                <!-- Background Image -->

                <app-image-field
                  [field]="getControl(displayConfig.get('background_image.uri'))"
                  label="Background Image"
                  [required]="false"
                ></app-image-field>

                <app-image-field
                  [field]="getControl(displayConfig.get('logo.uri'))"
                  label="Logo"
                  [required]="false"
                ></app-image-field>
              </mat-card-content>
            </mat-card>
          }
        </div>

        <!-- Add Display Configuration Button -->
        <div fxLayout="row" fxLayoutAlign="center center" class="add-button-container">
          <button mat-stroked-button type="button" (click)="addDisplayConfig()">
            <mat-icon>add</mat-icon>
            Add Display Configuration
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Webhooks (Expansion Panels) -->
    <mat-accordion>
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>webhook</mat-icon>
            Claim Webhook
          </mat-panel-title>
          <mat-panel-description>
            @if (form.get('claimsWebhook.url')?.value) {
              Configured: {{ form.get('claimsWebhook.url')?.value }}
            } @else {
              Optional - URL to receive claim data during issuance
            }
          </mat-panel-description>
        </mat-expansion-panel-header>
        <app-webhook-config-edit [group]="getFormGroup('claimsWebhook')"></app-webhook-config-edit>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>webhook</mat-icon>
            Notification Webhook
          </mat-panel-title>
          <mat-panel-description>
            @if (form.get('notificationWebhook.url')?.value) {
              Configured: {{ form.get('notificationWebhook.url')?.value }}
            } @else {
              Optional - URL to receive notifications during issuance
            }
          </mat-panel-description>
        </mat-expansion-panel-header>
        <app-webhook-config-edit
          [group]="getFormGroup('notificationWebhook')"
        ></app-webhook-config-edit>
      </mat-expansion-panel>
    </mat-accordion>

    <!-- VCT Information Card (SD-JWT only) -->
    @if (!isMdocFormat) {
      <mat-card>
        <mat-card-header>
          <mat-card-title>
            <mat-icon>description</mat-icon>
            Verifiable Credential Type (VCT)
          </mat-card-title>
          <mat-card-subtitle>SD-JWT VC specific configuration</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content fxLayout="column" fxLayoutGap="16px">
          <!-- VCT Mode Selection -->
          <div fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="start center">
            <span>Host VCT Metadata:</span>
            <mat-button-toggle-group
              [value]="vctMode"
              (change)="onVctModeChange($event.value)"
              aria-label="VCT Type"
            >
              <mat-button-toggle value="string">
                <mat-icon>link</mat-icon>
                No (Custom URI)
              </mat-button-toggle>
              <mat-button-toggle value="object">
                <mat-icon>data_object</mat-icon>
                Yes (Host Metadata)
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>

          <!-- Custom VCT URI Input (when not hosting metadata) -->
          @if (vctMode === 'string') {
            <mat-form-field>
              <mat-label>VCT URI</mat-label>
              <input
                matInput
                formControlName="vctString"
                placeholder="https://example.com/credential/my-credential-type"
              />
              <mat-icon matSuffix>link</mat-icon>
              @if (form.get('vctString')?.invalid && form.get('vctString')?.touched) {
                <mat-error>VCT URI is required</mat-error>
              }
              <mat-hint>
                Enter a custom VCT identifier URI. No metadata will be hosted by this system.
              </mat-hint>
            </mat-form-field>
          }

          <!-- Auto-generated VCT URI (when hosting metadata) -->
          @if (vctMode === 'object') {
            <div class="vct-auto-uri">
              <mat-icon>link</mat-icon>
              <span>
                VCT URI (auto-generated): <code>{{ getVctUri() }}</code>
              </span>
            </div>

            <div class="vct-hint">
              <mat-icon>info</mat-icon>
              <span>
                Define VCT metadata that will be hosted at the VCT URI. The <code>vct</code> field
                will be added automatically by EUDIPLO.
              </span>
            </div>
            <app-editor
              [schema]="vctSchema"
              formControlName="vct"
              [errors]="form.get('vct')?.errors"
            ></app-editor>
          }
        </mat-card-content>
      </mat-card>
    }

    <!-- mDOC Configuration Card (mDOC only) -->
    @if (isMdocFormat) {
      <mat-card>
        <mat-card-header>
          <mat-card-title>
            <mat-icon>description</mat-icon>
            mDOC Configuration
          </mat-card-title>
          <mat-card-subtitle>mDOC (ISO 18013-5) specific configuration</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content fxLayout="column" fxLayoutGap="16px">
          <!-- Document Type Preset -->
          <mat-form-field>
            <mat-label>Document Type Preset</mat-label>
            <mat-select (selectionChange)="onDocTypePresetChange($event.value)">
              @for (preset of docTypePresets; track preset.value) {
                <mat-option [value]="preset">{{ preset.label }}</mat-option>
              }
            </mat-select>
            <mat-icon matSuffix>list_alt</mat-icon>
            <mat-hint>Select a common document type or choose Custom</mat-hint>
          </mat-form-field>

          <!-- Document Type -->
          <mat-form-field>
            <mat-label>Document Type (docType)</mat-label>
            <input matInput formControlName="docType" placeholder="org.iso.18013.5.1.mDL" />
            <mat-icon matSuffix>badge</mat-icon>
            <mat-hint>The document type identifier (e.g., org.iso.18013.5.1.mDL)</mat-hint>
          </mat-form-field>

          <!-- Namespace -->
          <mat-form-field>
            <mat-label>Default Namespace</mat-label>
            <input matInput formControlName="namespace" placeholder="org.iso.18013.5.1" />
            <mat-icon matSuffix>folder_open</mat-icon>
            <mat-hint>Default namespace for claims (e.g., org.iso.18013.5.1)</mat-hint>
          </mat-form-field>

          <!-- Claims by Namespace -->
          <h4>Claims by Namespace (Optional)</h4>
          <p class="field-description">
            Define claims organized by namespace. Use this when you need claims from multiple
            namespaces.
          </p>
          <app-editor
            formControlName="claimsByNamespace"
            [errors]="form.get('claimsByNamespace')?.errors"
          ></app-editor>
        </mat-card-content>
      </mat-card>
    }

    <!-- Advanced Configuration -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>settings_applications</mat-icon>
          Advanced Configuration
        </mat-panel-title>
        <mat-panel-description> Optional advanced settings and schemas </mat-panel-description>
      </mat-expansion-panel-header>

      <div fxLayout="column" fxLayoutGap="16px" class="expansion-content">
        <!-- Default Claims -->
        <h4>
          Default claims to include in every credential if no others are provided. Good for demo
          purposes
        </h4>
        <app-editor formControlName="claims" [errors]="form.get('claims')?.errors"></app-editor>

        <!-- Disclosure Frame (SD-JWT only) -->
        @if (!isMdocFormat) {
          <h4>Disclosure Frame (SD-JWT)</h4>
          <app-editor
            formControlName="disclosureFrame"
            [errors]="form.get('disclosureFrame')?.errors"
          ></app-editor>
        }

        <!-- JSON Schema -->
        <h4>JSON Schema</h4>
        <p>Used to validate passed claims against a JSON schema</p>
        <app-editor formControlName="schema" [errors]="form.get('schema')?.errors"></app-editor>

        <!-- Embedded Disclosure Policy -->
        <h4>Embedded Disclosure Policy</h4>
        <app-editor
          [schema]="embeddedDisclosurePolicySchema"
          formControlName="embeddedDisclosurePolicy"
          [errors]="form.get('embeddedDisclosurePolicy')?.errors"
        ></app-editor>
      </div>
    </mat-expansion-panel>

    <!-- Action Buttons -->
    <div fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="end center">
      <button mat-button type="button" [routerLink]="['../']">Cancel</button>
      <button mat-flat-button type="submit" [disabled]="loading">
        @if (loading) {
          <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
        }
        @if (!loading) {
          <mat-icon>{{ create ? 'add' : 'save' }}</mat-icon>
        }
        {{ create ? 'Create' : 'Save' }} Configuration
      </button>
    </div>
  </form>
</div>
