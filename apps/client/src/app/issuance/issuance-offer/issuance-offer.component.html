<div fxLayout="column" fxFlex fxLayoutGap="24px">
  <!-- Header -->
  <div fxLayout="row" fxLayoutAlign="space-between center">
    <h2>Generate Issuance Offer</h2>
    <button mat-icon-button [routerLink]="['../']" matTooltip="Back to Issuance">
      <mat-icon>arrow_back</mat-icon>
    </button>
  </div>

  <!-- Loading State -->
  @if (loading) {
    <div fxLayout="row" fxLayoutAlign="center center" class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <span>Loading configurations...</span>
    </div>
  }

  <!-- Main Content -->
  @if (!loading) {
    <!-- Form Section -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()" fxLayout="column" fxLayoutGap="24px">
      <!-- Configuration Selection Card -->
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>settings</mat-icon>
            Offer Configuration
          </mat-card-title>
          <mat-card-subtitle>
            Select an issuance configuration to generate an offer
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content fxLayout="column" fxLayoutGap="16px">
          <!-- Issuance Configuration Selection -->
          <mat-form-field class="full-width">
            <mat-label>Issuance Configuration</mat-label>
            <mat-select formControlName="issuanceId">
              <mat-option value="">Select a configuration</mat-option>
              @for (config of configs; track config.id) {
                <mat-option [value]="config.id">
                  {{ config.id }}
                </mat-option>
              }
            </mat-select>
            <mat-icon matSuffix>rule</mat-icon>
            @if (form.get('issuanceId')?.invalid && form.get('issuanceId')?.touched) {
              <mat-error>Please select an issuance configuration</mat-error>
            }
          </mat-form-field>

          <!-- Credential Configuration IDs -->
          @if (selectedConfig) {
            <mat-form-field class="full-width">
              <mat-label>Credential Configuration IDs</mat-label>
              <mat-select formControlName="credentialConfigurationIds" multiple>
                @for (
                  binding of selectedConfig.credentialIssuanceBindings;
                  track binding.credentialConfigId
                ) {
                  <mat-option [value]="binding.credentialConfigId">
                    {{ binding.credentialConfigId }}
                  </mat-option>
                }
              </mat-select>
              <mat-icon matSuffix>badge</mat-icon>
              <mat-hint
                >Leave empty to use all configurations from the selected issuance config</mat-hint
              >
            </mat-form-field>
          }
        </mat-card-content>
      </mat-card>
      @if (fields.length > 0) {
        <mat-card>
          <mat-card-header>
            <mat-card-title>Dynamic Form</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            @for (form of elements; track elements) {
              <formly-form
                [form]="getForm(form.id)"
                [fields]="fields"
                [model]="model"
              ></formly-form>
              @if (form.claims) {
                <button mat-button type="button" (click)="addPreConfigured(form)">
                  Add pre configured
                </button>
              }
            }
          </mat-card-content>
          <mat-card-actions fxLayout="row" fxLayoutAlign="end center">
            <button mat-button type="button" (click)="importClaims()">Import config</button>
          </mat-card-actions>
        </mat-card>
      } @else if (selected?.claimsWebhook) {
        <mat-card class="webhook-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>webhook</mat-icon>
              Claim Webhook
            </mat-card-title>
            <mat-card-subtitle>Webhook to fetch claims</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <p>Webhook URL: {{ selected!.claimsWebhook!.url }}</p>
          </mat-card-content>
        </mat-card>
      }

      <mat-divider></mat-divider>

      <div fxLayout="row" fxLayoutAlign="end center">
        <button mat-button type="button" (click)="resetForm()">Reset</button>
        <button
          mat-flat-button
          color="primary"
          type="submit"
          [disabled]="form.invalid || generatingOffer"
        >
          Generate Offer
        </button>
      </div>
    </form>

    <!-- No Configurations State -->
    @if (configs.length === 0) {
      <mat-card class="empty-state">
        <mat-card-content>
          <div fxLayout="column" fxLayoutAlign="center center" class="empty-content">
            <mat-icon>warning</mat-icon>
            <h3>No Issuance Configurations</h3>
            <p>You need to create at least one issuance configuration before generating offers.</p>
            <button mat-raised-button color="primary" [routerLink]="['../issuance-config/create']">
              <mat-icon>add</mat-icon>
              Create Issuance Configuration
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    }
  }
</div>
