<div fxLayout="column" fxFlex fxLayoutGap="24px">
  <!-- Header -->
  <div fxLayout="row" fxLayoutAlign="space-between center">
    <h2>{{ create ? 'Create' : 'Edit' }} Issuance Configuration</h2>
    <div fxLayout="row" fxLayoutAlign="end center">
      <!-- JSON View Button -->
      <button mat-stroked-button (click)="viewAsJson()" matTooltip="View/Edit as JSON">
        <mat-icon>code</mat-icon>
        JSON View
      </button>
      <button mat-icon-button [routerLink]="['../']" matTooltip="Back to list">
        <mat-icon>arrow_back</mat-icon>
      </button>
    </div>
  </div>

  <!-- Main Form -->
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <!-- Basic Information Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>settings</mat-icon>
          Basic Information
        </mat-card-title>
      </mat-card-header>
      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- Configuration ID -->
        <mat-form-field class="full-width">
          <mat-label>Configuration ID</mat-label>
          <input matInput formControlName="id" placeholder="unique-issuance-config-id" />
          <mat-icon matSuffix>fingerprint</mat-icon>
          @if (form.get('id')?.invalid && form.get('id')?.touched) {
            <mat-error>Configuration ID is required</mat-error>
          }
        </mat-form-field>

        <!-- Description -->
        <mat-form-field class="full-width">
          <mat-label>Description</mat-label>
          <input matInput formControlName="description" placeholder="Enter description" />
          <mat-icon matSuffix>description</mat-icon>
          @if (form.get('description')?.invalid && form.get('description')?.touched) {
            <mat-error>Description is required</mat-error>
          }
        </mat-form-field>

        <!-- Batch Size -->
        <mat-form-field class="full-width">
          <mat-label>Batch Size</mat-label>
          <input matInput type="number" formControlName="batchSize" placeholder="1" min="1" />
          <mat-icon matSuffix>batch_prediction</mat-icon>
          <mat-hint>Number of credentials issued in a single batch (default: 1)</mat-hint>
          @if (form.get('batchSize')?.invalid && form.get('batchSize')?.touched) {
            <mat-error>Batch size must be at least 1</mat-error>
          }
        </mat-form-field>
        <mat-slide-toggle formControlName="dPopRequired">
          <div fxLayout="column">
            <span><strong>DPop Required</strong></span>
            <span class="toggle-description"
              >Enable DPop (Delegated Proof of Possession) for this configuration</span
            >
          </div>
        </mat-slide-toggle>
      </mat-card-content>
    </mat-card>

    <!-- Credential Configurations Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>description</mat-icon>
          Credential Configurations
        </mat-card-title>
      </mat-card-header>
      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- Credential Config Selection -->
        <mat-form-field class="full-width">
          <mat-label>Select Credential Configurations</mat-label>
          <mat-select formControlName="credentialConfigIds" multiple>
            @for (config of availableCredentialConfigs; track config.id) {
              <mat-option [value]="config.id">
                <div fxLayout="column">
                  <span
                    ><strong>{{ config.id }}</strong></span
                  >
                  <span class="option-description">{{ config.vct?.name || 'No VCT name' }}</span>
                </div>
              </mat-option>
            }
          </mat-select>
          <mat-icon matSuffix>link</mat-icon>
          <mat-hint>Select one or more credential configurations to include</mat-hint>
          @if (
            form.get('credentialConfigIds')?.invalid && form.get('credentialConfigIds')?.touched
          ) {
            <mat-error>At least one credential configuration must be selected</mat-error>
          }
        </mat-form-field>

        <!-- Selected Configurations Preview -->
        @if (form.get('credentialConfigIds')?.value?.length > 0) {
          <div>
            <div><strong>Selected Configurations:</strong></div>
            <div fxLayout="row wrap" fxLayoutGap="8px" class="selected-configs">
              @for (configDisplay of getSelectedCredentialConfigsDisplay(); track configDisplay) {
                <mat-chip-set>
                  <mat-chip>{{ configDisplay }}</mat-chip>
                </mat-chip-set>
              }
            </div>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Authentication Configuration Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>security</mat-icon>
          Authentication Configuration
        </mat-card-title>
        <mat-card-subtitle>Configure authentication settings</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content formGroupName="authenticationConfig" fxLayout="column" fxLayoutGap="16px">
        <mat-form-field>
          <mat-label>Authentication Method</mat-label>
          <mat-select formControlName="method">
            <mat-option value="none">None</mat-option>
            <mat-option value="auth">Auth</mat-option>
            <mat-option value="presentationDuringIssuance">Presentation During Issuance</mat-option>
          </mat-select>
        </mat-form-field>

        <div formGroupName="config" fxLayout="column" fxLayoutGap="16px">
          @if (form.get('authenticationConfig.method')?.value === 'presentationDuringIssuance') {
            <mat-form-field>
              <mat-label>Type</mat-label>
              <mat-select formControlName="type" placeholder="Type">
                @for (type of presentationConfigs; track type) {
                  <mat-option [value]="type.id">{{ type.id }} - {{ type.description }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          }
          @if (form.get('authenticationConfig.method')?.value === 'auth') {
            <mat-form-field>
              <mat-label>Endpoint of the authorization server</mat-label>
              <input matInput formControlName="url" placeholder="URL" />
            </mat-form-field>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Claims Configuration Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>webhook</mat-icon>
          Claims Webhook (Optional)
        </mat-card-title>
        <mat-card-subtitle>URL to receive claims data</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <app-webhook-config [group]="getFormGroup('claimsWebhook')"></app-webhook-config>
      </mat-card-content>
    </mat-card>

    <!-- Webhook Configuration Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>webhook</mat-icon>
          Notification Webhook (Optional)
        </mat-card-title>
        <mat-card-subtitle>URL to receive notification data</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <app-webhook-config [group]="getFormGroup('notifyWebhook')"></app-webhook-config>
      </mat-card-content>
    </mat-card>

    <!-- Action Buttons -->
    <div fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="end center">
      <button mat-button type="button" [routerLink]="['../']">Cancel</button>
      <button mat-flat-button type="submit" [disabled]="form.invalid || loading">
        @if (loading) {
          <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
        }
        @if (!loading) {
          <mat-icon>{{ create ? 'add' : 'save' }}</mat-icon>
        }
        {{ create ? 'Create' : 'Save' }} Configuration
      </button>
    </div>
  </form>
</div>
