<div fxLayout="column" fxFlex fxLayoutGap="24px">
  <div fxLayout="row" fxLayoutAlign="space-between center">
    <div>
      <h2>Status List Configuration</h2>
      <p class="subtitle">Configure status list settings for newly issued credentials</p>
    </div>
  </div>

  @if (isLoading) {
    <div fxLayout="row" fxLayoutAlign="center center" class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
    </div>
  } @else {
    <mat-card>
      <mat-card-header>
        <mat-icon mat-card-avatar>list_alt</mat-icon>
        <mat-card-title>Status List Settings</mat-card-title>
        <mat-card-subtitle>
          Configure how credential status is tracked. Changes only affect newly created status
          lists.
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="configForm" fxLayout="column" fxLayoutGap="24px">
          <!-- Capacity Configuration -->
          <div class="config-section">
            <h3>
              <mat-icon>straighten</mat-icon>
              Status List Capacity
            </h3>
            <p class="section-description">
              Number of entries in the status list. Larger lists can track more credentials but use
              more storage. Leave empty to use the global default (10,000).
            </p>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>List capacity</mat-label>
              <input
                matInput
                type="number"
                formControlName="capacity"
                placeholder="Leave empty for global default"
              />
              <mat-hint>
                Current: {{ formatCapacity(configForm.get('capacity')?.value) }}
              </mat-hint>
              @if (configForm.get('capacity')?.hasError('min')) {
                <mat-error>Capacity must be at least 100</mat-error>
              }
            </mat-form-field>

            <div class="capacity-presets" fxLayout="row wrap" fxLayoutGap="8px">
              <button
                mat-stroked-button
                type="button"
                (click)="configForm.patchValue({ capacity: 1000 })"
                [color]="configForm.get('capacity')?.value === 1000 ? 'primary' : undefined"
              >
                1,000
              </button>
              <button
                mat-stroked-button
                type="button"
                (click)="configForm.patchValue({ capacity: 10000 })"
                [color]="configForm.get('capacity')?.value === 10000 ? 'primary' : undefined"
              >
                10,000
              </button>
              <button
                mat-stroked-button
                type="button"
                (click)="configForm.patchValue({ capacity: 50000 })"
                [color]="configForm.get('capacity')?.value === 50000 ? 'primary' : undefined"
              >
                50,000
              </button>
              <button
                mat-stroked-button
                type="button"
                (click)="configForm.patchValue({ capacity: 100000 })"
                [color]="configForm.get('capacity')?.value === 100000 ? 'primary' : undefined"
              >
                100,000
              </button>
              <button
                mat-stroked-button
                type="button"
                (click)="configForm.patchValue({ capacity: null })"
                [color]="!configForm.get('capacity')?.value ? 'accent' : undefined"
              >
                Use default
              </button>
            </div>
          </div>

          <mat-divider></mat-divider>

          <!-- Bits Configuration -->
          <div class="config-section">
            <h3>
              <mat-icon>memory</mat-icon>
              Bits per Status
            </h3>
            <p class="section-description">
              Number of bits per credential status entry. More bits allow more status states (e.g.,
              suspended) but use more storage.
            </p>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Bits per status</mat-label>
              <mat-select formControlName="bits">
                <mat-select-trigger>
                  {{ getSelectedBitsLabel() }}
                </mat-select-trigger>
                @for (option of bitsOptions; track option.value) {
                  <mat-option [value]="option.value">
                    <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
                      <mat-icon>memory</mat-icon>
                      <div>
                        <strong>{{ option.label }}</strong>
                        <div class="option-description">{{ option.description }}</div>
                      </div>
                    </div>
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>

            @if (configForm.get('bits')?.value >= 2) {
              <div class="info-box">
                <mat-icon>info</mat-icon>
                <span>
                  <strong>{{ configForm.get('bits')?.value }} bits</strong> allows
                  {{ Math.pow(2, configForm.get('bits')?.value) }} distinct status values, enabling
                  states like suspended in addition to valid/revoked.
                </span>
              </div>
            }
          </div>

          <mat-divider></mat-divider>

          <!-- TTL Configuration -->
          <div class="config-section">
            <h3>
              <mat-icon>schedule</mat-icon>
              JWT Time-to-Live (TTL)
            </h3>
            <p class="section-description">
              How long verifiers can cache the status list JWT before fetching a fresh copy. The JWT
              will include <code>exp</code> and <code>ttl</code> claims per RFC 9528. Leave empty to
              use the global default (1 hour).
            </p>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>TTL (seconds)</mat-label>
              <input
                matInput
                type="number"
                formControlName="ttl"
                placeholder="Leave empty for global default"
              />
              <mat-hint> Current: {{ formatTtl(configForm.get('ttl')?.value) }} </mat-hint>
              @if (configForm.get('ttl')?.hasError('min')) {
                <mat-error>TTL must be at least 60 seconds</mat-error>
              }
            </mat-form-field>

            <div class="length-presets" fxLayout="row wrap" fxLayoutGap="8px">
              <button
                mat-stroked-button
                type="button"
                (click)="configForm.patchValue({ ttl: 300 })"
                [color]="configForm.get('ttl')?.value === 300 ? 'primary' : undefined"
              >
                5 min
              </button>
              <button
                mat-stroked-button
                type="button"
                (click)="configForm.patchValue({ ttl: 900 })"
                [color]="configForm.get('ttl')?.value === 900 ? 'primary' : undefined"
              >
                15 min
              </button>
              <button
                mat-stroked-button
                type="button"
                (click)="configForm.patchValue({ ttl: 3600 })"
                [color]="configForm.get('ttl')?.value === 3600 ? 'primary' : undefined"
              >
                1 hour
              </button>
              <button
                mat-stroked-button
                type="button"
                (click)="configForm.patchValue({ ttl: 86400 })"
                [color]="configForm.get('ttl')?.value === 86400 ? 'primary' : undefined"
              >
                24 hours
              </button>
              <button
                mat-stroked-button
                type="button"
                (click)="configForm.patchValue({ ttl: null })"
                [color]="!configForm.get('ttl')?.value ? 'accent' : undefined"
              >
                Use default
              </button>
            </div>
          </div>

          <mat-divider></mat-divider>

          <!-- Immediate Update Configuration -->
          <div class="config-section">
            <h3>
              <mat-icon>bolt</mat-icon>
              JWT Regeneration Mode
            </h3>
            <p class="section-description">
              Controls when the status list JWT is regenerated after a credential status change
              (e.g., revocation).
            </p>

            <div class="toggle-section" fxLayout="row" fxLayoutAlign="space-between center">
              <div>
                <strong>Immediate Update</strong>
                <p class="toggle-description">
                  @if (configForm.get('immediateUpdate')?.value) {
                    JWT is regenerated immediately on every status change. Verifiers always see the
                    latest status, but uses more server resources.
                  } @else {
                    JWT is regenerated lazily when requested and TTL has expired. More efficient,
                    but verifiers may see stale status until TTL expires.
                  }
                </p>
              </div>
              <mat-slide-toggle formControlName="immediateUpdate" color="primary">
              </mat-slide-toggle>
            </div>

            @if (configForm.get('immediateUpdate')?.value) {
              <div class="info-box warning">
                <mat-icon>warning</mat-icon>
                <span>
                  <strong>Performance note:</strong> Immediate mode regenerates the JWT on every
                  status change. For high-volume scenarios, consider using lazy mode with a shorter
                  TTL instead.
                </span>
              </div>
            }
          </div>

          <mat-divider></mat-divider>

          <!-- Aggregation Configuration -->
          <div class="config-section">
            <h3>
              <mat-icon>hub</mat-icon>
              Status List Aggregation
            </h3>
            <p class="section-description">
              Per RFC 9528 Section 9, status list aggregation enables verifiers to pre-fetch all
              status lists for offline validation. When enabled, each status list JWT includes an
              <code>aggregation_uri</code> pointing to an endpoint that returns all status list
              URIs.
            </p>

            <div class="toggle-section" fxLayout="row" fxLayoutAlign="space-between center">
              <div>
                <strong>Enable Aggregation</strong>
                <p class="toggle-description">
                  @if (configForm.get('enableAggregation')?.value) {
                    Status list JWTs include an <code>aggregation_uri</code> claim. Verifiers can
                    use this to pre-fetch all status lists for offline validation scenarios.
                  } @else {
                    Status list JWTs do not include aggregation information. Verifiers must fetch
                    each status list individually.
                  }
                </p>
              </div>
              <mat-slide-toggle formControlName="enableAggregation" color="primary">
              </mat-slide-toggle>
            </div>
          </div>
        </form>
      </mat-card-content>

      <mat-card-actions fxLayout="row" fxLayoutAlign="space-between center">
        <button
          mat-button
          color="warn"
          (click)="onReset()"
          [disabled]="isSaving"
          matTooltip="Reset to global defaults"
        >
          <mat-icon>restart_alt</mat-icon>
          Reset to Defaults
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="onSave()"
          [disabled]="configForm.invalid || isSaving"
        >
          @if (isSaving) {
            <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
          } @else {
            <mat-icon>save</mat-icon>
          }
          Save Configuration
        </button>
      </mat-card-actions>
    </mat-card>

    <div class="info-banner">
      <mat-icon>warning</mat-icon>
      <span>
        <strong>Note:</strong> Changes to status list configuration only affect newly created status
        lists. Existing status lists retain their original configuration.
      </span>
    </div>
  }
</div>
