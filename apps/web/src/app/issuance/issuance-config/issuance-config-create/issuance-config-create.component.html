<div fxLayout="column" fxFlex fxLayoutGap="24px">
  <!-- Header -->
  <div fxLayout="row" fxLayoutAlign="space-between center">
    <h2>{{ create ? 'Create' : 'Edit' }} Issuance Configuration</h2>
    <button mat-icon-button [routerLink]="['../']" matTooltip="Back to list">
      <mat-icon>arrow_back</mat-icon>
    </button>
  </div>

  <!-- Main Form -->
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <!-- Basic Information Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>settings</mat-icon>
          Basic Information
        </mat-card-title>
      </mat-card-header>
      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- Configuration ID -->
        <mat-form-field class="full-width">
          <mat-label>Configuration ID</mat-label>
          <input
            matInput
            formControlName="id"
            placeholder="unique-issuance-config-id"
            [readonly]="!create"
          />
          <mat-icon matSuffix>fingerprint</mat-icon>
          @if (form.get('id')?.invalid && form.get('id')?.touched) {
          <mat-error>Configuration ID is required</mat-error>
          }
        </mat-form-field>

        <!-- Batch Size -->
        <mat-form-field class="full-width">
          <mat-label>Batch Size</mat-label>
          <input matInput type="number" formControlName="batchSize" placeholder="1" min="1" />
          <mat-icon matSuffix>batch_prediction</mat-icon>
          <mat-hint>Number of credentials issued in a single batch (default: 1)</mat-hint>
          @if (form.get('batchSize')?.invalid && form.get('batchSize')?.touched) {
          <mat-error>Batch size must be at least 1</mat-error>
          }
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- Authentication Configuration Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>security</mat-icon>
          Authentication Configuration
        </mat-card-title>
      </mat-card-header>
      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- Authentication Method -->
        <mat-form-field class="full-width">
          <mat-label>Authentication Method</mat-label>
          <mat-select formControlName="authMethod">
            <mat-option value="none">
              <div fxLayout="column">
                <span><strong>Pre-authorized Code Flow</strong></span>
                <span class="option-description">No user authentication required</span>
              </div>
            </mat-option>
            <mat-option value="auth">
              <div fxLayout="column">
                <span><strong>Authorized Code Flow</strong></span>
                <span class="option-description">User authentication with redirect</span>
              </div>
            </mat-option>
            <mat-option value="presentationDuringIssuance">
              <div fxLayout="column">
                <span><strong>Presentation During Issuance</strong></span>
                <span class="option-description">OID4VP credential presentation required</span>
              </div>
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>lock</mat-icon>
        </mat-form-field>

        <!-- Authentication Configuration JSON -->
        @if (form.get('authMethod')?.value !== 'none') {
        <mat-form-field class="full-width">
          <mat-label>Authentication Configuration (JSON)</mat-label>
          <textarea
            matInput
            formControlName="authConfig"
            placeholder='{"redirectUri": "https://your-app.com/callback"}'
            rows="8"
            class="json-textarea"
          >
          </textarea>
          <mat-icon matSuffix>code</mat-icon>
          <mat-hint> JSON configuration specific to the selected authentication method </mat-hint>
        </mat-form-field>
        }
      </mat-card-content>
    </mat-card>

    <!-- Credential Configurations Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>description</mat-icon>
          Credential Configurations
        </mat-card-title>
      </mat-card-header>
      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- Credential Config Selection -->
        <mat-form-field class="full-width">
          <mat-label>Select Credential Configurations</mat-label>
          <mat-select formControlName="selectedCredentialConfigs" multiple>
            @for (config of availableCredentialConfigs; track config.id) {
            <mat-option [value]="config.id">
              <div fxLayout="column">
                <span
                  ><strong>{{ config.id }}</strong></span
                >
                <span class="option-description">{{ config.vct?.name || 'No VCT name' }}</span>
              </div>
            </mat-option>
            }
          </mat-select>
          <mat-icon matSuffix>link</mat-icon>
          <mat-hint>Select one or more credential configurations to include</mat-hint>
          @if ( form.get('selectedCredentialConfigs')?.invalid &&
          form.get('selectedCredentialConfigs')?.touched ) {
          <mat-error>At least one credential configuration must be selected</mat-error>
          }
        </mat-form-field>

        <!-- Selected Configurations Preview -->
        @if (form.get('selectedCredentialConfigs')?.value?.length > 0) {
        <div>
          <div><strong>Selected Configurations:</strong></div>
          <div fxLayout="row wrap" fxLayoutGap="8px" class="selected-configs">
            @for (configDisplay of getSelectedCredentialConfigsDisplay(); track configDisplay) {
            <mat-chip-set>
              <mat-chip>{{ configDisplay }}</mat-chip>
            </mat-chip-set>
            }
          </div>
        </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Webhook Configuration Card -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>webhook</mat-icon>
          Notification Webhook (Optional)
        </mat-card-title>
      </mat-card-header>
      <mat-card-content fxLayout="column" fxLayoutGap="16px">
        <!-- Webhook URL -->
        <mat-form-field class="full-width">
          <mat-label>Webhook URL</mat-label>
          <input
            matInput
            formControlName="webhookUrl"
            placeholder="https://your-app.com/webhook"
            type="url"
          />
          <mat-icon matSuffix>link</mat-icon>
          <mat-hint>URL to receive notification callbacks</mat-hint>
        </mat-form-field>

        <!-- Webhook Authentication -->
        @if (form.get('webhookUrl')?.value) {
        <mat-form-field class="full-width">
          <mat-label>Webhook Authentication (JSON)</mat-label>
          <textarea
            matInput
            formControlName="webhookAuth"
            placeholder='{"type": "bearer", "token": "your-secret-token"}'
            rows="6"
            class="json-textarea"
          >
          </textarea>
          <mat-icon matSuffix>security</mat-icon>
          <mat-hint>Optional authentication configuration for webhook calls</mat-hint>
        </mat-form-field>
        }
      </mat-card-content>
    </mat-card>

    <!-- Action Buttons -->
    <div fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="end center">
      <button mat-button type="button" [routerLink]="['../']">Cancel</button>
      <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid || loading">
        @if (loading) {
        <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
        } @if (!loading) {
        <mat-icon>{{ create ? 'add' : 'save' }}</mat-icon>
        }
        {{ create ? 'Create' : 'Save' }} Configuration
      </button>
    </div>
  </form>
</div>
