openapi: 3.1.0
info:
  title: EUDIPLO Webhook API
  description: |
    Webhook API specification for integrating with EUDIPLO credential issuance flows.

    Implement these endpoints to receive webhook callbacks from EUDIPLO during credential issuance.

    ## Webhook Types

    1. **Claims Webhook** - Unified endpoint for resolving credential claims
       - Handles both internal and external authorization server flows
       - Receives `identity` when using external AS (Keycloak, Auth0, etc.)
       - Receives `credentials` when wallet presents credentials during issuance
    2. **Notification Webhook** - Called when wallet notifies about credential status changes

    ## Unified Payload

    The `/claims` endpoint now uses a unified payload that works for all flows:
    - `session` and `credential_configuration_id` are always present
    - `identity` is present when using external authorization server
    - `credentials` is present when wallet presents credentials

    ## Authentication

    Webhooks support optional API key authentication via a configurable header (default: `x-api-key`).
  version: 1.1.0
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0
  contact:
    name: EUDIPLO Project
    url: https://github.com/openwallet-foundation-labs/eudiplo

servers:
  - url: https://your-webhook-server.example.com
    description: Your webhook server

tags:
  - name: Claims
    description: Endpoints for resolving credential claims
  - name: Notifications
    description: Endpoints for receiving credential status notifications

paths:
  /claims:
    post:
      operationId: handleClaimsWebhook
      summary: Unified Claims Webhook
      description: |
        Unified endpoint for resolving credential claims in all issuance flows.

        **Supported Flows:**
        - **Authorization Code with External AS**: Receives `identity` with token claims from external AS
        - **Pre-authorized Code with Presentation**: Receives `credentials` with disclosed claims

        **Request Payload:**
        - `session` and `credential_configuration_id` are always present
        - `identity` contains external AS token info (iss, sub, token_claims) when applicable
        - `credentials` contains presented credentials with disclosed claims when applicable

        Your webhook should check which fields are present and handle accordingly.
      tags:
        - Claims
      security:
        - ApiKeyAuth: []
        - {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClaimsWebhookRequest'
            examples:
              externalAsFlow:
                summary: External AS flow (with identity)
                value:
                  session: "session-uuid-123"
                  credential_configuration_id: "employee_credential"
                  identity:
                    iss: "https://keycloak.example.com/realms/eudiplo"
                    sub: "user-uuid-456"
                    token_claims:
                      email: "john.doe@example.com"
                      given_name: "John"
                      family_name: "Doe"
              presentationFlow:
                summary: Presentation flow (with credentials)
                value:
                  session: "session-uuid-123"
                  credential_configuration_id: "citizen"
                  credentials:
                    - id: "eu.europa.ec.eudi.pid.1"
                      values:
                        - address:
                            locality: "Berlin"
                            postal_code: "10115"
      responses:
        '200':
          description: Claims resolved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimsWebhookResponse'
              examples:
                immediateIssuance:
                  summary: Immediate credential issuance
                  value:
                    citizen:
                      town: "You live in Berlin"
                      registered_at: "2024-01-15"
                deferredIssuance:
                  summary: Deferred credential issuance
                  value:
                    deferred: true
                    interval: 10
        '400':
          description: Invalid request payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - invalid API key
        '500':
          description: Internal server error

  /notify:
    post:
      operationId: handleNotificationWebhook
      summary: Notification Webhook
      description: |
        Called when the wallet notifies about credential status changes.

        **Events**:
        - `credential_accepted` - Wallet successfully stored the credential
        - `credential_failure` - Wallet failed to process the credential
        - `credential_deleted` - User deleted the credential from wallet

        This is a fire-and-forget notification; the response is acknowledged but not processed.
      tags:
        - Notifications
      security:
        - ApiKeyAuth: []
        - {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationWebhookRequest'
            examples:
              credentialAccepted:
                summary: Credential accepted by wallet
                value:
                  session: "session-uuid-123"
                  notification:
                    id: "notification-uuid-789"
                    event: "credential_accepted"
                    credentialConfigurationId: "citizen"
              credentialDeleted:
                summary: Credential deleted from wallet
                value:
                  session: "session-uuid-123"
                  notification:
                    id: "notification-uuid-790"
                    event: "credential_deleted"
                    credentialConfigurationId: "citizen"
      responses:
        '200':
          description: Notification acknowledged
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationWebhookResponse'
        '400':
          description: Invalid request payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - invalid API key
        '500':
          description: Internal server error

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: |
        API key for webhook authentication.
        The header name is configurable in EUDIPLO webhook configuration.

  schemas:
    # =========================================================================
    # Request Schemas
    # =========================================================================

    ClaimsWebhookRequest:
      type: object
      description: |
        Unified request payload for claims webhook.
        Handles both internal and external authorization server flows.
      required:
        - session
        - credential_configuration_id
      properties:
        session:
          type: string
          description: Session ID for the issuance flow
          example: "session-uuid-123"
        credential_configuration_id:
          type: string
          description: Credential configuration ID being requested
          example: "employee_credential"
        identity:
          $ref: '#/components/schemas/AuthorizationIdentity'
        credentials:
          type: array
          description: Array of presented credentials with disclosed claims (present in presentation flow)
          items:
            $ref: '#/components/schemas/PresentedCredential'

    AuthorizationIdentity:
      type: object
      description: |
        Identity information from an authorization server token.
        Present when using external AS (authorization code flow).
      required:
        - iss
        - sub
        - token_claims
      properties:
        iss:
          type: string
          format: uri
          description: Token issuer (the authorization server URL)
          example: "https://keycloak.example.com/realms/eudiplo"
        sub:
          type: string
          description: Subject identifier from the token
          example: "user-uuid-456"
        token_claims:
          type: object
          description: All claims from the access token
          additionalProperties: true
          example:
            email: "john.doe@example.com"
            given_name: "John"
            family_name: "Doe"

    PresentedCredential:
      type: object
      description: A presented credential with disclosed claims
      required:
        - id
        - values
      properties:
        id:
          type: string
          description: Credential configuration ID
          example: "eu.europa.ec.eudi.pid.1"
        values:
          type: array
          description: Array of disclosed credential values (one per credential instance)
          items:
            $ref: '#/components/schemas/DisclosedClaims'

    DisclosedClaims:
      type: object
      description: |
        Disclosed claims from a credential.
        The structure depends on the credential type and selective disclosure.
      additionalProperties: true
      example:
        address:
          locality: "Berlin"
          postal_code: "10115"
        age_over_18: true

    NotificationWebhookRequest:
      type: object
      description: Request payload for notification webhook
      required:
        - session
        - notification
      properties:
        session:
          type: string
          description: Session ID for the issuance flow
          example: "session-uuid-123"
        notification:
          $ref: '#/components/schemas/Notification'

    Notification:
      type: object
      description: Notification details from wallet
      required:
        - id
        - credentialConfigurationId
      properties:
        id:
          type: string
          description: Unique identifier for the notification
          example: "notification-uuid-789"
        event:
          $ref: '#/components/schemas/NotificationEvent'
        credentialConfigurationId:
          type: string
          description: The credential configuration ID associated with this notification
          example: "citizen"

    NotificationEvent:
      type: string
      description: Notification event types as defined by OID4VCI
      enum:
        - credential_accepted
        - credential_failure
        - credential_deleted

    # =========================================================================
    # Response Schemas
    # =========================================================================

    ClaimsWebhookResponse:
      type: object
      description: |
        Response from a claims webhook.

        Return either:
        1. Claims data keyed by credential configuration ID for immediate issuance
        2. `deferred: true` for deferred issuance (wallet will poll)
      properties:
        deferred:
          type: boolean
          description: |
            When true, indicates deferred issuance.
            The wallet will receive a transaction_id to poll later.
          example: false
        interval:
          type: integer
          description: Recommended polling interval in seconds for deferred issuance
          minimum: 1
          default: 5
          example: 10
        redirectUri:
          type: string
          format: uri
          description: Optional redirect URI for OAuth-style redirects
      additionalProperties:
        type: object
        description: Claims data for a credential configuration
        additionalProperties: true
      example:
        citizen:
          town: "Berlin"
          registered_at: "2024-01-15"

    NotificationWebhookResponse:
      type: object
      description: Acknowledgment response for notification webhooks
      required:
        - status
      properties:
        status:
          type: string
          enum:
            - ok
            - error
          description: Status of notification processing
        message:
          type: string
          description: Optional message (typically for errors)
      example:
        status: "ok"

    ErrorResponse:
      type: object
      description: Error response
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
          example: "Invalid request payload"
